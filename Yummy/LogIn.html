<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>SIERRA</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <!-- Favicons -->
    <link href="assets/img/logoNew.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Amatic+SC:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet" />
    <link href="assets/css/login.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.21/dist/sweetalert2.min.css"
      integrity="sha256-7jUS+MWeqkFdmW9ozkZ7mPagz+QmMbsBlt+Q3MsE+FU="
      crossorigin="anonymous"
    />
    <style></style>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
      <div class="container d-flex align-items-center justify-content-between">
        <a
          href="index.html"
          class="logo d-flex align-items-center me-auto me-lg-0"
        >
          <img src="assets/img/logoNew.png" alt="" />
          <h1>SIERRA</h1>
        </a>
        <nav id="navbar" class="navbar">
          <ul>
            <li><a href="index.html">首頁</a></li>
            <li><a href="#about">關於我們</a></li>
            <li class="dropdown">
              <a href="desserts.html#/"
                ><span>甜點</span>
                <i class="bi bi-chevron-down dropdown-indicator"></i
              ></a>
              <ul>
                <li><a href="desserts.html#/moldCake">整模蛋糕</a></li>
                <li><a href="desserts.html#/roomTemperature">常溫蛋糕</a></li>
                <li><a href="desserts.html#/snack">點心</a></li>
                <li><a href="desserts.html#/longCake">長條蛋糕</a></li>
                <li><a href="desserts.html#/presents">禮盒</a></li>
              </ul>
            </li>
            <li><a href="Lessons.html">課程</a></li>
            <li><a href="Teacher.html">師資</a></li>
            <li><a href="#promotion">近期活動</a></li>
            <li class="dropdown">
              <a href="#"
                ><span>常見問題</span>
                <i class="bi bi-chevron-down dropdown-indicator"></i
              ></a>
              <ul>
                <li><a href="rule.html">常見問題</a></li>
                <li class="dropdown">
                  <a href="/MemberCenter.html"
                    ><span>會員中心</span>
                    <i class="bi bi-chevron-down dropdown-indicator"></i
                  ></a>
                  <ul>
                    <li>
                      <a href="/MemberCenter.html">會員優惠券</a>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#contact">聯絡我們</a></li>
          </ul>
        </nav>
        <!-- .navbar -->
        <div class="d-flex" style="justify-content: space-between">
          <!-- <a class="btn-book-a-table" href="lessonBook.html">預定課程</a> -->
          <div class="shoppingCartDiv me-3">
            <a
              class="js-toggle-cart"
              href="#"
              title="View cart"
              @click="getCartItems()"
            >
              <span class="shoppingCart badge badge-pill badge-warning"></span>
              <i class="bi bi-bag-fill" style="font-size: 35px"></i>
            </a>
          </div>
        </div>

        <!-- <div class="shoppingCartDiv">
            <a href="#" title="View cart" @click="getCartItems()">
              <span class="shoppingCart badge badge-pill badge-warning"></span>
              <i class="bi bi-cart"></i>
            </a>
          </div> -->
        <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
        <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
      </div>
    </header>
    <!-- End Header -->

    <main id="main" class="login-lock-height">
      <div
        class="w-100 h-100 d-flex justify-content-center align-items-center login-background-image"
      >
        <div class="wrapper" style="z-index: 5">
          <!-- // 表單右上叉叉
        <span class="icon-close text-light">
          <ion-icon name="close"></ion-icon>
        </span> -->
          <div class="form-box forgotPassword">
            <h2>忘記密碼</h2>
            <div
              class="text-danger error-list mt-3"
              id="forgotPassword-error-list"
            >
              <ul>
                <li></li>
              </ul>
            </div>
            <form action="" onsubmit="forgotPassword(event)">
              <div class="input-box">
                <span class="icon"><ion-icon name="person"></ion-icon></span>
                <input
                  type="text"
                  name="username"
                  id="forgot-username"
                  required
                />
                <label>使用者名稱</label>
              </div>
              <div class="input-box">
                <span class="icon"><ion-icon name="mail"></ion-icon></span>
                <input type="email" name="email" id="forgot-email" required />
                <label>電子信箱</label>
              </div>
              <button type="submit" class="btn-forgot-login-register">
                寄驗證信
              </button>
              <div class="forgot-login-register">
                <p>
                  想起來了嗎?
                  <a href="#" class="login-link">趕緊登入</a>
                </p>
              </div>
            </form>
          </div>

          <div class="form-box login">
            <h2>登入</h2>
            <div class="text-danger error-list mt-1" id="login-error-list">
              <ul>
                <li></li>
              </ul>
            </div>
            <form action="" onsubmit="login(event)">
              <div class="input-box">
                <span class="icon"><ion-icon name="person"></ion-icon></span>
                <input
                  type="text"
                  name="username"
                  id="login-username"
                  required
                />
                <label>使用者名稱</label>
              </div>
              <div class="input-box">
                <span
                  class="icon toggle-password"
                  onmousedown="showPassword(this)"
                  onmouseup="hidePassword(this)"
                  ><i class="fas fa-eye-slash"></i
                ></span>
                <input
                  type="password"
                  name="password"
                  id="login-password"
                  required
                />
                <label>密碼</label>
              </div>
              <div class="remember-forgot">
                <label><input type="checkbox" />記得我</label>
                <a href="#" class="forgotPassword-link">忘記密碼?</a>
              </div>
              <button type="submit " class="btn-forgot-login-register">
                開始購物
              </button>
              <div class="row row-cols-2 gx-3 mt-3">
                <div>
                  <!-- <div class="text-bg-dark fs-6 py-3 text-center rounded-2">第三方登入1</div> -->
                  <!-- <div id="g_id_onload"
                  data-client_id="355215602606-s2il7abeb0588htsu4j66vlvn0osfoi7.apps.googleusercontent.com"
                  data-context="signin" data-ux_mode="popup"
                  data-login_uri="https://localhost:520/api/Members/GoogleLogin" data-auto_prompt="false">
                </div>

                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                  data-text="signin" data-size="large" data-logo_alignment="left">
                </div> -->
                  <div id="btn-google-login"></div>
                </div>

                <!-- <div>
                <div class="text-bg-dark fs-6 py-3 text-center rounded-2">第三方登入2</div>
              </div> -->
              </div>
              <div class="forgot-login-register">
                <p>
                  還不是會員?
                  <a href="#" class="register-link">註冊</a>
                </p>
              </div>
            </form>
          </div>

          <div class="form-box register">
            <h2>註冊</h2>
            <div class="text-danger error-list mt-2" id="register-error-list">
              <ul>
                <li></li>
              </ul>
            </div>
            <form action="" onsubmit="register(event)">
              <div class="input-box">
                <span class="icon"><ion-icon name="person"></ion-icon> </span>
                <input
                  type="text"
                  name="username"
                  id="register-username"
                  required
                />
                <label>使用者名稱</label>
              </div>
              <div class="input-box">
                <span class="icon"><ion-icon name="mail"></ion-icon></span>
                <input type="email" name="email" id="register-email" required />
                <label>電子信箱</label>
              </div>
              <div class="input-box">
                <span
                  class="icon toggle-password"
                  onmousedown="showPassword(this)"
                  onmouseup="hidePassword(this)"
                  ><i class="fas fa-eye-slash"></i
                ></span>
                <input
                  type="password"
                  name="password"
                  id="register-password"
                  required
                />
                <label>密碼</label>
              </div>
              <div class="input-box">
                <span
                  class="icon toggle-password"
                  onmousedown="showPassword(this)"
                  onmouseup="hidePassword(this)"
                  ><i class="fas fa-eye-slash"></i
                ></span>
                <input
                  type="password"
                  name="confirm-password"
                  id="register-cofirmpassword"
                  required
                />
                <label>確認密碼</label>
              </div>
              <div class="remember-forgot">
                <label>
                  <input
                    type="checkbox"
                    id="terms-and-conditions-checkbox"
                    disabled
                  />我同意
                </label>
                <span id="terms-and-conditions">條款和條件</span>
              </div>
              <button type="submit " class="btn-forgot-login-register">
                加入會員
              </button>
              <div class="forgot-login-register">
                <p>
                  已經有帳號了?
                  <a href="#" class="login-link">登入</a>
                </p>
              </div>
            </form>
          </div>
        </div>
        <div class="loginfilter"></div>
      </div>
    </main>
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer" style="height: 25.3vh">
      <div class="container">
        <div class="row gy-3">
          <div class="col-lg-3 col-md-6 d-flex">
            <i class="bi bi-geo-alt icon"></i>
            <div>
              <h4>地址</h4>
              <p>
                A108 Adam Street <br />
                New York, NY 535022 - US<br />
              </p>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 footer-links d-flex">
            <i class="bi bi-telephone icon"></i>
            <div>
              <h4>預定方式</h4>
              <p>
                <strong>Phone:</strong> +1 5589 55488 55<br />
                <strong>Email:</strong> info@example.com<br />
              </p>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 footer-links d-flex">
            <i class="bi bi-clock icon"></i>
            <div>
              <h4>營業時間</h4>
              <p>
                <strong>星期一到六: 11AM</strong> - 23PM<br />
                Sunday: Closed
              </p>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Follow Us</h4>
            <div class="social-links d-flex">
              <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
              <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
              <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
              <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="copyright">
          &copy; Copyright <strong><span>SIERRA</span></strong
          >. All Rights Reserved
        </div>
      </div>
    </footer>
    <!-- End Footer -->

    <a
      href="#"
      class="scroll-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <div id="preloader"></div>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <!-- End #main -->

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/login.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
    >
      // 要用axios進行ajax呼叫
    </script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    >
      // 給基本圖示
    </script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    >
      // 給基本圖示
    </script>
    <script
      src="https://kit.fontawesome.com/d6092fcff6.js"
      crossorigin="anonymous"
    >
      // 給眼睛用的
    </script>
    <script
      src="
https://cdn.jsdelivr.net/npm/sweetalert2@11.7.21/dist/sweetalert2.all.min.js
"
    >
      //sweetalert2
    </script>
    <script>
      document
        .querySelector("#terms-and-conditions")
        .addEventListener("click", function () {
          fetch("TermsAndConditions.txt")
            .then((response) => response.text())
            .then((text) => {
              // 使用 SweetAlert 显示文本内容
              Swal.fire({
                title: "條件與細則",
                html: "<pre>" + text + "</pre>",
                confirmButtonText: "同意",
                showCancelButton: true,
                cancelButtonText: "取消",
                width: 1280,
              }).then((result) => {
                let termsChk = document.querySelector(
                  "#terms-and-conditions-checkbox"
                );
                termsChk.checked = result.isConfirmed ? true : false;
              });
            })
            .catch((error) => {
              console.error("Error loading Terms and Conditions:", error);
              Swal.fire({
                title: "Error",
                text: "Failed to load Terms and Conditions.",
                icon: "error",
              });
            });
        });

      async function forgotPassword(event) {
        event.preventDefault();
        let formUsername = document.querySelector("#forgot-username").value;
        let formEmail = document.querySelector("#forgot-email").value;

        // 移除之前的錯誤訊息
        document.querySelector("#forgotPassword-error-list").innerHTML = "";
        let url = "https://localhost:520/api/Members/ForgotPassword";
        let data = {
          Username: formUsername,
          Email: formEmail,
        };
        try {
          swalLoading();
          let response = await axios.post(url, data);
          Swal.close();
          swalSuccess(response.data);
        } catch (error) {
          let errorElement = document.createElement("li");
          errorElement.textContent = error.response.data;
          document
            .querySelector("#forgotPassword-error-list")
            .appendChild(errorElement);
          Swal.close();
          console.error("Error occurred:", error);
        }
      }

      async function login(event) {
        event.preventDefault();
        let formUsername = document.querySelector("#login-username").value;
        let formPassword = document.querySelector("#login-password").value;

        // 移除之前的錯誤訊息
        document.querySelector("#login-error-list").innerHTML = "";

        let url = "https://localhost:520/api/Members/Login";
        let data = {
          username: formUsername,
          password: formPassword,
        };

        try {
          let response = await axios.post(url, data);
          const token = response.data;

          saveJWTtoLocalStorge(token);

          window.location.href = "index.html"; // 導至首頁
        } catch (error) {
          let errorElement = document.createElement("li");
          errorElement.textContent = error.response.data;
          document.querySelector("#login-error-list").appendChild(errorElement);
          console.error("Error occurred:", error);
        }
      }

      async function register(event) {
        event.preventDefault();
        let formUsername = document.querySelector("#register-username").value;
        let formEmail = document.querySelector("#register-email").value;
        let formPassword = document.querySelector("#register-password").value;
        let formConfirmPassword = document.querySelector(
          "#register-cofirmpassword"
        ).value;
        let formIsTermsChecked = document.querySelector(
          "#terms-and-conditions-checkbox"
        ).checked;

        // 移除之前的錯誤訊息
        document.querySelector("#register-error-list").innerHTML = "";

        // 驗證密碼和確認密碼是否一致
        if (formPassword !== formConfirmPassword) {
          let errorElement = document.createElement("li");
          errorElement.textContent = "密碼和確認密碼不一致";
          document
            .querySelector("#register-error-list")
            .appendChild(errorElement);
          return;
        }
        if (!formIsTermsChecked) {
          let errorElement = document.createElement("li");
          errorElement.textContent = `請同意 "條款和條件"`;
          document
            .querySelector("#register-error-list")
            .appendChild(errorElement);
          return;
        } else {
          let url = "https://localhost:520/api/Members/Register";
          let data = {
            username: formUsername,
            password: formPassword,
            email: formEmail,
          };

          try {
            swalLoading();
            let response = await axios.post(url, data);
            Swal.close();
            swalSuccess(response.data);
          } catch (error) {
            let errorElement = document.createElement("li");
            errorElement.textContent = error.response.data;
            document
              .querySelector("#register-error-list")
              .appendChild(errorElement);
            Swal.close();
            console.error("Error occurred:", error);
          }
        }
      }

      // 畫面載入時就要有Google登入按鈕
      window.onload = function () {
        // 用Google提供的JavaScript API，初始化Google登入
        // ref:https://developers.google.com/identity/gsi/web/reference/js-reference
        google.accounts.id.initialize({
          client_id:
            "355215602606-s2il7abeb0588htsu4j66vlvn0osfoi7.apps.googleusercontent.com",
          callback: handleResponse,
        });

        // 渲染 Google 登入按鈕
        google.accounts.id.renderButton(
          document.querySelector("#btn-google-login"),
          {
            type: "standard", // "icon", "standard"
            theme: "filled_blue", // "outline", "filled_blue", "filled_black"
            size: "large", // "large", "medium", "small"
            text: "sigin_with", // "signin_with", "signup_with", "continue_with", "signin"
            shape: "rectangular", // "rectangular", "pill", "circle", "square"
            logo_alignment: "left", // "left", "center"
            width: 316, // 最大為400
            locale: "zh-TW", // "zh-TW", "zh-CN", "ja", "ko" (ref:https://zh.wikipedia.org/zh-tw/%E5%8C%BA%E5%9F%9F%E8%AE%BE%E7%BD%AE)
            //click_listener: onClickHandler //// 點擊時呼叫的JavaScript function
          }
        );

        //// 啟動 One Tap 按鈕
        //// ref:https://developers.google.com/identity/gsi/web/guides/integrate#when_to_display_the_one_tap_ui
        //// ref:https://developers.google.com/identity/gsi/web/reference/js-reference#PromptMomentNotification
        // google.accounts.id.prompt((notification) => {
        //   if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
        //     console.log(notification);
        //   }
        // });
      };

      // 處理Google認證的callback function
      async function handleResponse(response) {
        let credential = response.credential; // 可以拿到jwt.io解析，看裡面有什麼
        let payload = JSON.parse(
          decodeURIComponent(
            escape(
              window.atob(
                credential.split(".")[1].replace(/-/g, "+").replace(/_/g, "/")
              )
            )
          )
        );
        let username = payload.name;
        let imageURL = payload.picture;
        let email = payload.email;
        localStorage.setItem("googleAccountId", payload.sub);

        // 檢查使用者的email是否已經是Sierra會員，是(then)就如一般登入回傳JWT，否(catch)就再填入username和password進行註冊，
        let url = `https://localhost:520/api/Members/GoogleLogin?email=${email}`;
        axios
          .post(url)
          .then((res) => {
            const token = res.data;

            // 將 JWT Token, memberId, username 存至 LocalStorage
            saveJWTtoLocalStorge(token);

            Swal.fire({
              title: "成功!",
              text: "使用該帳號登入成功",
              icon: "success",
              showCancelButton: false, // 不顯示取消按鈕
              confirmButtonText: "確定", // 更改確定按鈕文字
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = "index.html"; // 導至首頁
              }
            });
          })
          .catch(async function (error) {
            const { value: formValues } = await Swal.fire({
              title: "註冊Sierra會員",
              html:
                "<label>使用者名稱</label>" +
                '<input type="text" id="swal-input-username" class="swal2-input" required>' +
                "<label>密碼</label>" +
                '<input type="password" id="swal-input-password" class="swal2-input" required>',
              focusConfirm: false,
              preConfirm: () => {
                const username = document.getElementById(
                  "swal-input-username"
                ).value;
                const password = document.getElementById(
                  "swal-input-password"
                ).value;

                if (!username || !password) {
                  Swal.showValidationMessage("請填寫所有欄位");
                }
                return [username, password];
              },
            });

            // if (formValues) {
            //   Swal.fire(JSON.stringify(formValues));
            // }

            let formUsername = formValues[0];
            let formPassword = formValues[1];
            let url = "https://localhost:520/api/Members/GoogleRegister";
            let data = {
              username: formUsername,
              password: formPassword,
              email: email,
            };

            try {
              let response = await axios.post(url, data);
              const token = response.data;

              // 將 JWT Token, memberId, username 存至 LocalStorage
              saveJWTtoLocalStorge(token);

              Swal.fire({
                title: "成功!",
                text: "註冊完成且登入成功",
                icon: "success",
                showCancelButton: false, // 不顯示取消按鈕
                confirmButtonText: "確定", // 更改確定按鈕文字
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = "index.html"; // 導至首頁
                }
              });
            } catch (error) {
              Swal.fire({
                icon: "error",
                title: error.response.data,
                text: "請更換您的使用者名稱!",
              });
              console.error("Error occurred:", error);
            }
          });

        // debug專區
        // console.log(response);
        // console.log(credential);
        // console.log(payload);
        // console.log("ID: " + payload.sub);
        // console.log('Full Name: ' + payload.name);
        // console.log('Given Name: ' + payload.given_name);
        // console.log('Family Name: ' + payload.family_name);
        // console.log("Image URL: " + payload.picture);
        // console.log("Email: " + payload.email);
      }

      // 將 JWT Token, memberId, username, imageUrl 存至 LocalStorage
      function saveJWTtoLocalStorge(token) {
        localStorage.setItem("jwtToken", token);
        let tokenParts = token.split(".");
        let payload = JSON.parse(atob(tokenParts[1]));
        localStorage.setItem("memberId", payload.memberId);
        localStorage.setItem("username", payload.username);
        imageUrl = `https://localhost:520/Uploads/${payload.imageName}`;
        localStorage.setItem("imageUrl", imageUrl);
      }

      // 監聽登入頁3大區塊的滑動效果
      const wrapper = document.querySelector(".wrapper");
      const forgotPasswordLink = document.querySelector(".forgotPassword-link");
      const loginLinks = document.querySelectorAll(".login-link");
      const registerLink = document.querySelector(".register-link");
      // const iconClose = document.querySelector(".icon-close");

      forgotPasswordLink.addEventListener("click", () => {
        wrapper.classList.add("active-forgotPassword");
        wrapper.classList.remove("active-register");
      });

      registerLink.addEventListener("click", () => {
        wrapper.classList.add("active-register");
        wrapper.classList.remove("active-forgotPassword");
      });

      loginLinks.forEach((ele) => {
        ele.addEventListener("click", () => {
          wrapper.classList.remove("active-forgotPassword");
          wrapper.classList.remove("active-register");
        });
      });
    </script>
  </body>
</html>
