<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>SIERRA</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="assets/img/logoNew.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link href="assets/css/login.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.21/dist/sweetalert2.min.css"
      integrity="sha256-7jUS+MWeqkFdmW9ozkZ7mPagz+QmMbsBlt+Q3MsE+FU="
      crossorigin="anonymous"
    />
    <style>
      .terms-span {
  font-style: italic;
  cursor: pointer; 
}
    </style>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
      <div class="container d-flex align-items-center justify-content-between">
        <a
          href="index.html"
          class="logo d-flex align-items-center me-auto me-lg-0"
        >
          <img src="assets/img/logoNew.png" alt="" />
          <h1>SIERRA</h1>
        </a>

        <nav id="navbar" class="navbar">
          <ul>
            <li><a href="index.html">首頁</a></li>
            <li><a href="#about">關於我們</a></li>
            <li class="dropdown">
              <a href="#menu"
                ><span>甜點</span>
                <i class="bi bi-chevron-down dropdown-indicator"></i
              ></a>
              <ul>
                <li><a href="desserts.html#/moldCake">整模蛋糕</a></li>
                <li><a href="desserts.html#/roomTemperature">常溫蛋糕</a></li>
                <li><a href="desserts.html#/snack">點心</a></li>
                <li><a href="desserts.html#/longCake">長條蛋糕</a></li>
                <li><a href="desserts.html#/presents">禮盒</a></li>
              </ul>
            </li>
            <li><a href="Lessons.html">課程</a></li>
            <li><a href="Teacher.html">師資</a></li>
            <li><a href="#promotion">近期活動</a></li>
            <li class="dropdown">
              <a href="#"
                ><span>常見問題</span>
                <i class="bi bi-chevron-down dropdown-indicator"></i
              ></a>
              <ul>
                <li><a href="rule.html">常見問題</a></li>
                <li class="dropdown">
                  <a href="/MemberCenter.html"
                    ><span>會員中心</span>
                    <i class="bi bi-chevron-down dropdown-indicator"></i
                  ></a>
                  <ul>
                    <li>
                      <a href="/MemberCenter.html">會員優惠券</a>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#contact">聯絡我們</a></li>
          </ul>
        </nav>
        <!-- .navbar -->
        <div class="d-flex" style="justify-content: space-between">
          <!-- <a class="btn-book-a-table" href="lessonBook.html">預定課程</a> -->
          <div class="shoppingCartDiv me-3">
            <a
              class="js-toggle-cart"
              href="#"
              title="View cart"
              @click="getCartItems()"
            >
              <span class="shoppingCart badge badge-pill badge-warning"></span>
              <i class="bi bi-bag-fill" style="font-size: 35px"></i>
            </a>
          </div>
        </div>

        <!-- <div class="shoppingCartDiv">
            <a href="#" title="View cart" @click="getCartItems()">
              <span class="shoppingCart badge badge-pill badge-warning"></span>
              <i class="bi bi-cart"></i>
            </a>
          </div> -->
        <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
        <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
      </div>
    </header>
    <!-- End Header -->

    <!-- start shopping cart -->
    <aside class="cart js-cart mt-5">
      <div class="cart__header">
        <h1 class="cart__title">購物車</h1>
        <p class="cart__text">
          <a
            class="button button--light js-toggle-cart"
            href="#"
            title="Close cart"
          >
            <i class="bi bi-x-square-fill"></i>
          </a>
        </p>
      </div>
      <div class="cart__products js-cart-products cart-scrollerbar">
        <p class="cart__empty js-cart-empty">新增商品到購物車吧~</p>
        <div
          class="cart__product js-cart-product-template"
          v-for="item in cartItems"
          :key="item.id"
        >
          <article class="js-cart-product">
            <h1 class="product_name">{{ item.dessertName }}</h1>

            數量: <span class="qty">{{ item.quantity }}</span> * NT
            <span class="dessertPrice">{{ item.price }}</span>
            <p>
              <a
                class="js-remove-product"
                href="#"
                title="Delete product"
                @click="removeProduct(item.id)"
              >
                刪除
              </a>
            </p>
          </article>
        </div>
      </div>
      <div class="cart__footer">
        <p class="cart__text">
          <a class="button" href="shoppingCart.html" title="Buy products"
            >結帳
          </a>
        </p>
      </div>
    </aside>
    <!-- End shopping cart -->

    <!-- 結帳流程圖示 -->
    <section class="TopcheckoutCircle">
      <div class="Topcontainer mt-5">
        <div class="progress-container">
          <div class="progress"></div>
          <div class="circle active">填寫資料</div>
          <div class="circle">訂單確認</div>
        </div>
        <!-- <button class="btn" id="prev" disabled>Prev</button>
          <button class="btn" id="next">Next</button> -->
      </div>
    </section>

    <div id="app">
      <div class="container">
        <div class="row mt-3 mb-3">
          <div class="card">
            <div class="card-body">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th scope="col">課程名稱</th>
                    <th scope="col">報名人數</th>
                    <th scope="col">單價</th>
                    <th scope="col">開課時間</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{ initialSelectedLesson.lessonTitle}}</td>
                    <td>{{initialSelectedRegistrationCount}} 人</td>
                    <td>
                      <i class="fas fa-dollar"></i>
                      <span style="color: red">
                        {{ initialSelectedLesson.lessonPrice }}</span
                      >
                    </td>
                    <td>{{ formatDate(initialSelectedLesson.lessonTime) }}</td>
                  </tr>
                </tbody>
              </table>
              <hr />
              <div class="mt-3">
                <h5 class="card-title totalPrice">
                  <i class="fas fa-dollar"></i>
                  <span>總金額: <span style="color: red">{{total}}</span></span>
                </h5>
              </div>
            </div>
          </div>
        </div>

        <!-- 第二個 Card -->
        <div class="row mt-3 mb-3">
          <div class="card">
            <div class="card-body">
              <div class="card-header bg-light mb-3">
                <h5 class="card-title">使用者資料</h5>
              </div>
              <div class="mb-3">
                <label for="username" class="form-label">使用者名稱</label>
                <input
                  type="text "
                  class="form-control"
                  id="username"
                  v-model="customer.username"
                  disabled
                />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">電子信箱</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  v-model="customer.email"
                  disabled
                />
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">電話號碼</label>
                <input
                  type="tel"
                  class="form-control"
                  id="phone"
                  v-model="customer.phone"
                />
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label">性別</label>
                <select
                  class="form-select"
                  id="gender"
                  v-model="customer.gender"
                >
                  <option value="male">男性</option>
                  <option value="female">女性</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- 訂單備註 Card -->
        <div class="row">
          <div class="card mb-4">
            <div class="card-body">
              <div class="card-header bg-light mb-3">
                <h5 class="card-title">訂單備註</h5>
              </div>
              <textarea class="form-control" rows="3" v-model="note"></textarea>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="card mb-4">
            <div class="card-body position-relative">
              <h5 class="card-title">付款資料</h5>
              <div class="d-flex">
                <div class="col-5">
                  <!-- <h5 class="card-title">付款資料</h5> -->
                  <select
                    class="form-select"
                    id="paymentMethod"
                    v-model="payMethod"
                  >
                    <option value="信用卡">信用卡</option>
                  </select>
                </div>
                <div
                  class="form-check justify-content-end position-absolute end-0"
                >
                <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="termsModalLabel">服務條款及隱私權政策</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body left-aligned-content">
                      
一、隱私權保護政策的適用範圍
隱私權保護政策內容，包括本網站如何處理在您使用網站服務時收集到的個人識別資料。隱私權保護政策不適用於本網站以外的相關連結網站，也不適用於非本網站所委託或參與管理的人員。
<br>
二、個人資料的蒐集、處理及利用方式
當您造訪本網站或使用本網站所提供之功能服務時，我們將視該服務功能性質，請您提供必要的個人資料，並在該特定目的範圍內處理及利用您的個人資料；非經您書面同意，本網站不會將個人資料用於其他用途。
本網站在您使用服務信箱、問卷調查等互動性功能時，會保留您所提供的姓名、電子郵件地址、聯絡方式及使用時間等。
於一般瀏覽時，伺服器會自行記錄相關行徑，包括您使用連線設備的IP位址、使用時間、使用的瀏覽器、瀏覽及點選資料記錄等，做為我們增進網站服務的參考依據，此記錄為內部應用，決不對外公佈。
為提供精確的服務，我們會將收集的問卷調查內容進行統計與分析，分析結果之統計數據或說明文字呈現，除供內部研究外，我們會視需要公佈統計數據及說明文字，但不涉及特定個人之資料。
<br>
三、資料之保護
指由經過授權的人員才能接觸您的個人資料，如因業務需要有必要委託其他單位提供服務時，本網站亦會嚴格要求其遵守保密義務，並且採取必要檢查程序以確定其將確實遵守。
<br>
四、網站對外的相關連結
本網站的網頁提供其他網站的網路連結，您也可經由本網站所提供的連結，點選進入其他網站。但該連結網站不適用本網站的隱私權保護政策，您必須參考該連結網站中的隱私權保護政策。
<br>
五、與第三人共用個人資料之政策
本網站絕不會提供、交換、出租或出售任何您的個人資料給其他個人、團體、私人企業或公務機關，但有法律依據或合約義務者，不在此限。
<br>
前項但書之情形包括不限於：
<br>
1.經由您書面同意。
2.法律明文規定。
3.為免除您生命、身體、自由或財產上之危險。
4.與公務機關或學術研究機構合作，基於公共利益為統計或學術研究而有必要，且資料經過提供者處理或蒐集著依其揭露方式無從識別特定之當事人。
5.當您在網站的行為，違反服務條款或可能損害或妨礙網站與其他使用者權益或導致任何人遭受損害時，經網站管理單位研析揭露您的個人資料是為了辨識、聯絡或採取法律行動所必要者。
6.本網站委託廠商協助蒐集、處理或利用您的個人資料時，將對委外廠商或個人善盡監督管理之責。
<br>
六、Cookie之使用
為了提供您最佳的服務，本網站會在您的電腦中放置並取用我們的Cookie，若您不願接受Cookie的寫入，您可在您使用的瀏覽器功能項中設定隱私權等級為高，即可拒絕Cookie的寫入，但可能會導至網站某些功能無法正常執行 。
<br>
七、隱私權保護政策之修正
本網站隱私權保護政策將因應需求隨時進行修正，修正後的條款將刊登於網站上。


                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
                      </div>
                    </div>
                  </div>
                </div>
                  <!-- <h5 class="card-title"><a href="#">個資同意說明書</a></h5> -->
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="agreeTerms"
                  />
                  <label class="form-check-label" for="agreeTerms"
                    >我同意<span 
                    class="terms-span" 
                    @mouseover="hoverLabel = true" 
                    @mouseleave="hoverLabel = false" 
                    @click="showModal" 
                    :style="hoverLabel ? {color: 'blue'} : {}"
                  >網站服務條款及隱私權政策</label
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 驗證 -->
        <div
          class="form-group d-flex justify-content-center"
          v-if="errorMsgs.length>0"
        >
          <p>請填寫完整資料:</p>
          <br />
          <ul style="list-style-type: disc">
            <li v-for="error in errorMsgs" class="text-danger">{{error}}</li>
          </ul>
        </div>

        <div class="row">
          <button class="btn btn-success" @click="submitAllData">
            提交表單
          </button>
          <!-- <a style="text-decoration: none; color: green" href="ecpayLesson.html" >前往綠界付款</a> -->

          <div class="card mb-4 col-2 d-flex justify-content-end"></div>
        </div>
      </div>

      <!-- ======= Footer ======= -->
      <footer id="footer" class="footer">
        <div class="container">
          <div class="row gy-3">
            <div class="col-lg-3 col-md-6 d-flex">
              <i class="bi bi-geo-alt icon"></i>
              <div>
                <h4>地址</h4>
                <p>
                  桃園市 中壢區 <br />
                  新生路二段421號<br />
                </p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 footer-links d-flex">
              <i class="bi bi-telephone icon"></i>
              <div>
                <h4>預定方式</h4>
                <p>
                  <strong>電話:</strong> 03 426 0163<br />
                  <strong>Email:</strong> fuen283@ispan.com<br />
                </p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 footer-links d-flex">
              <i class="bi bi-clock icon"></i>
              <div>
                <h4>營業時間</h4>
                <p>
                  <strong>星期一到六: 11AM</strong> - 23PM<br />
                  星期日: 公休
                </p>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 footer-links">
              <h4>追蹤我們</h4>
              <div class="social-links d-flex">
                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="instagram"
                  ><i class="bi bi-instagram"></i
                ></a>
                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
              </div>
            </div>
          </div>
        </div>

        <div class="container">
          <div class="copyright">
            &copy; Copyright <strong><span>SIERRA</span></strong
            >. All Rights Reserved
          </div>
          <div class="credits">Designed by SIERRA</div>
        </div>
      </footer>
      <!-- End Footer -->
      <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
      <script src="assets/js/variables.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <!-- Updated Vue 3 CDN -->
      <script src="https://unpkg.com/vue@3.2.36/dist/vue.global.prod.js"></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
        integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>
      <script
        src="https://kit.fontawesome.com/76eb3f0e59.js"
        crossorigin="anonymous"
      ></script>
      <script src="assets/js/cart.js"></script>
      <script src="assets/js/login.js"></script>
      <script
        src="
       https://cdn.jsdelivr.net/npm/sweetalert2@11.7.21/dist/sweetalert2.all.min.js
       "
      >
        //sweetalert2
      </script>

      <script>
        const app = Vue.createApp({
          data() {
            const selectedLesson = JSON.parse(
              localStorage.getItem("selectedLesson")
            );
            const selectedRegistrationCount = parseInt(
              localStorage.getItem("selectedRegistrationCount")
            );
            return {
              errorMsgs: [],
              initialSelectedLesson: selectedLesson || {},
              initialSelectedRegistrationCount: selectedRegistrationCount || 0,
              customer: {
                // 顧客資料
                username: "",
                email: "",
                phone: "",
                gender: "",
              },
              note: "", // 訂單備註
              payMethod: "", // 付款方式
              hoverLabel: false,
            };
          },
          methods: {
            async getCartItems() {
              const username = localStorage.getItem("username"); // Replace this with the actual username
              try {
                const response = await axios.get(
                  `${variables.API_URL}DessertCarts?username=${username}`,
                  config
                );

                const cartItems = response.data;
                const cartProductsContainer = $(".js-cart-products");
                cartProductsContainer.empty(); // Clear the existing cart items

                if (cartItems.length === 0) {
                  // Display the cart empty message if there are no items
                  cartProductsContainer.append(
                    '<p class="cart__empty js-cart-empty">新增商品到購物車吧~</p>'
                  );
                } else {
                  cartItems.forEach((item) => {
                    const cartProductTemplate = `
            <div class="cart__product"  v-for="item in cartItems" :key="item.id">
            <article class="js-cart-product">
            <div class="d-flex">
            <img class="menu-img img-fluid" src="/assets/img/${item.dessertImage}" style="
            height: 50px; width: 50px;   "/>
             <h1 class="product_name ">${item.dessertName}</h1> </div>
              <div class="cart__product__qty">
              數量: <span class="qty">${item.count}</span> * NT
              <span class="dessertPrice">${item.price}</span>         
                <a class="js-remove-product" href="#" title="Delete product" onclick="handleDelete(${item.dessertCartItemId})" >
                  刪除
                </a>
               </div>
            </article>
          </div>
            `;
                    cartProductsContainer.append(cartProductTemplate);
                  });
                }
                numberOfProducts = cartItems.length;
                $(".cart__footer .button").text("結帳 " + numberOfProducts);
                $(".shoppingCart").text(numberOfProducts);
              } catch (error) {
                console.error("Error getting cart items:", error);
              }
            },
            formatDate(dateString) {
              const date = new Date(dateString);
              const year = date.getFullYear();
              const month = ("0" + (date.getMonth() + 1)).slice(-2);
              const day = ("0" + date.getDate()).slice(-2);

              let hours = date.getHours();
              const minutes = ("0" + date.getMinutes()).slice(-2);

              let ampm = "AM";
              if (hours >= 12) {
                ampm = "PM";
                if (hours > 12) {
                  // 將 24 小時制轉換為 12 小時制
                  hours -= 12;
                }
              } else if (hours === 0) {
                hours = 12; // 0 點轉換為 12 AM
              }

              return `${year}/${month}/${day} ${ampm} ${hours}:${minutes}`;
            },
            showModal() {
    const modal = new bootstrap.Modal(document.getElementById('termsModal'));
    modal.show();
  },
            validateForm: function () {
              let isValid = true;
              this.errorMsgs = [];
              // 驗證電話號碼
              if (!this.customer.phone.trim()) {
                isValid = false;
                this.errorMsgs.push("請輸入電話號碼");
              } else if (!/^\d{10}$/.test(this.customer.phone)) {
                isValid = false;
                this.errorMsgs.push("電話號碼格式不正確");
              }
              // 驗證性別
              if (!this.customer.gender) {
                isValid = false;
                this.errorMsgs.push("請選擇性別");
              }
              // 驗證付款方式
              if (!this.payMethod) {
                isValid = false;
                this.errorMsgs.push("請選擇付款方式");
              }
              // 驗證服務條款與隱私政策
              const agreeTermsElement = document.getElementById("agreeTerms");
              if (!agreeTermsElement.checked) {
                isValid = false;
                this.errorMsgs.push("您必須同意服務條款及隱私權政策");
              }
              return isValid;
            },
            async fetchCustomerData() {
              const username = localStorage.getItem("username"); // 從localStorage中獲取username
              try {
                const response = await axios.get(
                  `${variables.API_URL}LessonOrders/${username}`,
                  config
                );
                // 使用解構賦值來獲取 response 中的 gender
                const { gender, ...otherData } = response.data;
                // 根據 gender 的值來轉換為 "male" 或 "female"
                this.customer.gender = gender ? "male" : "female";
                // 將其他的資料也賦值到 customer
                this.customer = { ...this.customer, ...otherData };
              } catch (error) {
                console.error("Error fetching customer data", error);
              }
            },
            async submitAllData() {
              if (!this.validateForm()) {
                return;
              }
              try {
                // 1. Update User Data
                await this.updateUserData();

                // 2. Submit New Order
                await this.submitOrder();

                // Notify the user of successful submission
                //alert("建立訂單成功!");
                Swal.fire({
                  title: "<strong> 訂單建立成功</strong>",
                  icon: "success",
                  html: "<a href=//localhost:5501/ecpayLesson.html>前往綠界付款</a> ",
                  showCloseButton: true,
                  showCancelButton: true,
                  focusConfirm: false,
                });
              } catch (error) {
                console.error("Error during submission:", error);
                alert("Failed to submit data. Please try again.");
              }
            },
            async updateUserData() {
              const username = localStorage.getItem("username"); // 從localStorage中獲取username
              // 將 gender 從字串轉換為 boolean
              const genderBool = this.customer.gender === "male" ? true : false;
              //更新使用者電話性別
              const userData = {
                Phone: this.customer.phone,
                Gender: genderBool,
              };

              try {
                // 將使用者資料發送到後端以進行更新
                const response = await axios.put(
                  `${variables.API_URL}LessonOrders/${username}`,
                  userData,
                  config
                );

                if (response.status !== 200) {
                  throw new Error("Failed to update user data");
                }
              } catch (error) {
                console.error("Error updating user data:", error);
              }
            },
            async submitOrder() {
              // 創建訂單對象
              const orderData = {
                username: localStorage.getItem("username"), // 這可以作為標識符
                memberId: localStorage.getItem("memberId"),
                lessonTitle: this.initialSelectedLesson.lessonTitle, // 課程名稱
                numberOfPeople: this.initialSelectedRegistrationCount, // 報名人數
                lessonUnitPrice: this.initialSelectedLesson.lessonPrice, // 單價
                lessonId: this.initialSelectedLesson.lessonId,
                subtotal: this.subtotal,
                //lessonTime: this.initialSelectedLesson.lessonTime, // 開課時間
                lessonOrderTotal: this.total,
                note: this.note,
                payMethod: this.payMethod,
              };

              console.log(orderData);
              // 將訂單數據發送到後端
              try {
                const response = await axios.post(
                  `${variables.API_URL}LessonOrders`,
                  orderData,
                  config
                );

                if (response.status === 200) {
                  console.log("Order created successfully", response.data);
                } else {
                  throw new Error("Failed to create order");
                }
              } catch (error) {
                console.error("Error submitting order:", error);
                throw error;
              }
            },
          },
          computed: {
            total() {
              return (
                this.initialSelectedRegistrationCount *
                this.initialSelectedLesson.lessonPrice
              );
            },
            subtotal() {
              return (
                this.initialSelectedLesson.lessonPrice *
                this.initialSelectedRegistrationCount
              );
            },
          },
          mounted: function () {
            this.fetchCustomerData(); // 當頁面載入時取得userName資料
            this.getCartItems(); // 當頁面載入時從取出購物車數據
          },
        });
        app.mount("#app");
      </script>
    </div>
  </body>
</html>
